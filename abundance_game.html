<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø§Ø²ÛŒ ÙØ±Ø§ÙˆØ§Ù†ÛŒ Ø§Ø¨Ø±Ø§Ù‡Ø§Ù…-Ù‡ÛŒÚ©Ø³</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- PWA Manifest & Service Worker -->
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(registration => {
                    console.log('Service Worker registered:', registration);
                }).catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
            });
        }
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#facc15',
                        'dark-bg': '#1f2937',
                        'dark-card': '#374151',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
            color: #f3f4f6;
            min-height: 100vh;
        }
        /* Custom scrollbar for better look in dark mode */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6366f1;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="game-container" class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-secondary tracking-tight">Ø¨Ø§Ø²ÛŒ ÙØ±Ø§ÙˆØ§Ù†ÛŒ Ø§Ø¨Ø±Ø§Ù‡Ø§Ù…-Ù‡ÛŒÚ©Ø³</h1>
            <p class="text-gray-400 mt-2 text-lg">Ø¨Ø§ÛŒØ¯ Ú©Ù„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ù…Ø±ÙˆØ²Øª Ø±Ùˆ Ø®Ø±Ø¬ Ú©Ù†ÛŒ!</p>
        </header>

        <!-- Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Ú©Ø§Ø±Øª ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ² Ùˆ ØªØ§ÛŒÙ…Ø± -->
            <div class="lg:col-span-2 bg-dark-card p-6 rounded-xl shadow-2xl">
                <h2 id="day-status" class="text-2xl font-bold mb-4 text-primary">ÙˆØ¶Ø¹ÛŒØª: Ø±ÙˆØ² Û±</h2>
                
                <div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center mb-6">
                    <span class="text-lg font-semibold text-gray-300">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ù…Ø±ÙˆØ²:</span>
                    <span id="current-balance" class="text-3xl font-extrabold text-green-400">Û±,Û°Û°Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†</span>
                </div>

                <!-- ØªØ§ÛŒÙ…Ø± Ùˆ ÙˆØ¶Ø¹ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡ -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-center">
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <span class="text-lg text-gray-400">Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡:</span>
                        <div id="countdown-timer" class="text-4xl font-bold text-red-500 mt-1">23:59:59</div>
                    </div>
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <span class="text-lg text-gray-400">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø®Ø±Ø¬â€ŒØ´Ø¯Ù‡:</span>
                        <div id="spent-amount" class="text-4xl font-bold text-yellow-400 mt-1">Û° ØªÙˆÙ…Ø§Ù†</div>
                    </div>
                </div>

                <div id="timer-message" class="text-center mt-4 text-sm font-medium text-gray-300">
                    ØªØ§ Ù¾Ø§ÛŒØ§Ù† Ø±ÙˆØ² ÙØ±ØµØª Ø¯Ø§Ø±ÛŒ Ú©Ù„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø±Ùˆ Ø®Ø±Ø¬ Ú©Ù†ÛŒ.
                </div>
            </div>

            <!-- Ú©Ø§Ø±Øª Ø«Ø¨Øª Ø®Ø±ÛŒØ¯ -->
            <div class="lg:col-span-1 bg-dark-card p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-bold mb-4 text-primary border-b border-gray-700 pb-2">Ø«Ø¨Øª Ø®Ø±ÛŒØ¯ Ø¬Ø¯ÛŒØ¯</h2>
                
                <form id="purchase-form">
                    <div class="mb-4">
                        <label for="description" class="block text-sm font-medium text-gray-300 mb-1">ØªÙˆØ¶ÛŒØ­Ø§Øª Ø®Ø±ÛŒØ¯ (Ø¶Ø±ÙˆØ±ÛŒ)</label>
                        <input type="text" id="description" required class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-primary focus:border-primary">
                    </div>

                    <div class="mb-4">
                        <label for="amount" class="block text-sm font-medium text-gray-300 mb-1">Ù…Ø¨Ù„Øº Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)</label>
                        <input type="number" id="amount" required min="1" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-primary focus:border-primary">
                    </div>

                    <div class="mb-4">
                        <label for="image-file" class="block text-sm font-medium text-gray-300 mb-1">ØªØµÙˆÛŒØ± Ø®Ø±ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                        <input type="file" id="image-file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-indigo-600 cursor-pointer">
                        <p class="text-xs text-gray-400 mt-1">Ø­Ø¯Ø§Ú©Ø«Ø± Ø­Ø¬Ù… ØªØµÙˆÛŒØ± Û±Û°Û° Ú©ÛŒÙ„ÙˆØ¨Ø§ÛŒØª.</p>
                    </div>

                    <button type="submit" class="w-full bg-secondary text-gray-900 font-bold py-3 rounded-xl hover:bg-yellow-300 transition duration-200 shadow-lg shadow-yellow-500/50">
                        Ø«Ø¨Øª Ùˆ Ú©Ø³Ø± Ø§Ø² Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                    </button>
                    
                    <div id="form-message" class="mt-3 text-center text-sm font-medium text-red-400 hidden"></div>
                </form>
            </div>
        </main>

        <!-- Ø¨Ø®Ø´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ -->
        <section class="mt-10 bg-dark-card p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 text-primary border-b border-gray-700 pb-2">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‚Ø¨Ù„</h2>
            
            <div id="history-container" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar">
                <!-- ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±ÙˆØ²Ù‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒ Ø´ÙˆØ¯ -->
                <p id="no-history" class="text-gray-400 text-center py-4">Ù‡Ù†ÙˆØ² Ø±ÙˆØ²ÛŒ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ù†Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.</p>
            </div>
        </section>

        <!-- Ù…ÙˆØ¯Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ø±ÙˆØ² -->
        <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-dark-card p-6 rounded-xl shadow-2xl max-w-lg w-full custom-scrollbar max-h-full overflow-y-auto">
                <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                    <h3 id="modal-title" class="text-xl font-bold text-primary">Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø±ÛŒØ¯Ù‡Ø§</h3>
                    <button onclick="closeModal('details-modal')" class="text-gray-400 hover:text-white text-2xl font-bold">
                        &times;
                    </button>
                </div>
                
                <p id="modal-status" class="mb-4 text-lg font-semibold"></p>

                <div id="modal-purchases" class="space-y-4">
                    <!-- Ø¢ÛŒØªÙ… Ù‡Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒ Ø´ÙˆÙ†Ø¯ -->
                </div>
            </div>
        </div>

        <!-- Ù…ÙˆØ¯Ø§Ù„ Ù¾ÛŒØ§Ù… (Ù…ÙˆÙÙ‚ÛŒØª/Ø´Ú©Ø³Øª) -->
        <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-dark-card p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
                <h3 id="modal-msg-title" class="text-2xl font-bold mb-3 text-secondary"></h3>
                <p id="modal-msg-text" class="text-gray-300 mb-6"></p>
                <button onclick="closeModal('message-modal')" class="bg-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 transition duration-200">
                    Ø¨Ø§Ø´Ù‡
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ ---
        let gameState = {
            currentDay: 1,
            startTimestamp: 0,
            initialBalance: 1000000,
            currentBalance: 1000000,
            spentAmount: 0,
            purchases: [], // Ø®Ø±ÛŒØ¯Ù‡Ø§ÛŒ Ø±ÙˆØ² Ø¬Ø§Ø±ÛŒ
            history: [] // ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‚Ø¨Ù„
        };

        const TWENTY_FOUR_HOURS = 24 * 60 * 60 * 1000;
        let timerInterval;

        // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---

        // ØªØ¨Ø¯ÛŒÙ„ Ø¹Ø¯Ø¯ Ø¨Ù‡ ÙØ±Ù…Øª ØªÙˆÙ…Ø§Ù†ÛŒ (Ù…Ø«Ø§Ù„: 1000000 -> 1,000,000)
        const formatCurrency = (number) => {
            return new Intl.NumberFormat('fa-IR').format(number) + ' ØªÙˆÙ…Ø§Ù†';
        };

        // --- ØªÙˆØ§Ø¨Ø¹ LocalStorage ---

        const saveGameState = () => {
            try {
                localStorage.setItem('abundanceGame', JSON.stringify(gameState));
                console.log('Game state saved to localStorage.');
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                displayMessage('Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯!', 'Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ÙØ¶Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø­Ù„ÛŒØŒ Ù†ØªÙˆØ§Ù†Ø³ØªÛŒÙ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒÙ….', 'message-modal', 'text-red-500');
            }
        };

        const loadGameState = () => {
            try {
                const storedState = localStorage.getItem('abundanceGame');
                if (storedState) {
                    const loadedState = JSON.parse(storedState);
                    // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ØªØ¹Ø±ÛŒÙ Ø¨ÙˆØ¯Ù† ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø±
                    gameState = {
                        currentDay: loadedState.currentDay || 1,
                        startTimestamp: loadedState.startTimestamp || 0,
                        initialBalance: loadedState.initialBalance || 1000000,
                        currentBalance: loadedState.currentBalance || 1000000,
                        spentAmount: loadedState.spentAmount || 0,
                        purchases: loadedState.purchases || [],
                        history: loadedState.history || []
                    };
                    console.log('Game state loaded from localStorage.');
                }
            } catch (e) {
                console.error('Error loading from localStorage. Starting fresh.', e);
                // Ø§Ú¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯ØŒ Ø¨Ø§ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø´Ø±ÙˆØ¹ Ú©Ù†
            }
        };

        // --- ØªÙˆØ§Ø¨Ø¹ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ (UI) ---

        const updateUI = () => {
            const requiredBalance = gameState.currentDay * 1000000;

            document.getElementById('day-status').textContent = `ÙˆØ¶Ø¹ÛŒØª: Ø±ÙˆØ² ${gameState.currentDay}`;
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÙˆØ² Ø¬Ø§Ø±ÛŒ
            gameState.initialBalance = requiredBalance;

            document.getElementById('current-balance').textContent = formatCurrency(gameState.currentBalance);
            document.getElementById('spent-amount').textContent = formatCurrency(gameState.spentAmount);

            // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ù†Ú¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ¶Ø¹ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡
            const balanceElement = document.getElementById('current-balance');
            balanceElement.classList.remove('text-green-400', 'text-red-400');
            if (gameState.currentBalance === 0) {
                balanceElement.classList.add('text-green-400');
            } else {
                balanceElement.classList.add('text-red-400');
            }
            
            renderHistory();
        };

        const displayMessage = (title, text, modalId, titleColorClass = 'text-secondary') => {
            const modal = document.getElementById(modalId);
            document.getElementById('modal-msg-title').textContent = title;
            document.getElementById('modal-msg-title').className = `text-2xl font-bold mb-3 ${titleColorClass}`;
            document.getElementById('modal-msg-text').textContent = text;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeModal = (modalId) => {
            document.getElementById(modalId).classList.remove('flex');
            document.getElementById(modalId).classList.add('hidden');
        };

        // Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‚Ø¨Ù„
        const renderHistory = () => {
            const container = document.getElementById('history-container');
            container.innerHTML = '';
            
            if (gameState.history.length === 0) {
                document.getElementById('no-history').classList.remove('hidden');
                return;
            }
            
            document.getElementById('no-history').classList.add('hidden');
            
            gameState.history.slice().reverse().forEach(dayData => { // Ù†Ù…Ø§ÛŒØ´ Ø§Ø² Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù‚Ø¯ÛŒÙ…
                const statusColor = dayData.success ? 'bg-green-600' : 'bg-red-600';
                const statusText = dayData.success ? 'Ù…ÙˆÙÙ‚ÛŒØª' : 'Ø´Ú©Ø³Øª';
                
                const dayCard = document.createElement('div');
                dayCard.className = `p-4 rounded-lg shadow-md flex justify-between items-center ${statusColor} bg-opacity-30 border-r-8 ${dayData.success ? 'border-green-400' : 'border-red-400'}`;
                dayCard.innerHTML = `
                    <div>
                        <p class="font-bold text-lg text-gray-200">Ø±ÙˆØ² ${dayData.dayNumber}</p>
                        <p class="text-sm text-gray-400">${dayData.timestamp ? new Date(dayData.timestamp).toLocaleDateString('fa-IR') : 'ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                    </div>
                    <div class="text-center">
                        <span class="font-semibold text-white">${statusText}</span>
                        <p class="text-sm text-gray-300">Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù„: ${formatCurrency(dayData.spentAmount)}</p>
                    </div>
                    <button onclick="showDayDetails(${dayData.dayNumber})" class="bg-primary text-white text-sm font-semibold py-1 px-3 rounded-lg hover:bg-indigo-600 transition">
                        Ø¬Ø²Ø¦ÛŒØ§Øª
                    </button>
                `;
                container.appendChild(dayCard);
            });
        };

        // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø±ÛŒØ¯Ù‡Ø§ÛŒ ÛŒÚ© Ø±ÙˆØ² Ø®Ø§Øµ Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡
        const showDayDetails = (dayNumber) => {
            const dayData = gameState.history.find(d => d.dayNumber === dayNumber);
            if (!dayData) return;
            
            const titleElement = document.getElementById('modal-title');
            const statusElement = document.getElementById('modal-status');
            const purchasesContainer = document.getElementById('modal-purchases');
            
            titleElement.textContent = `Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø±ÛŒØ¯Ù‡Ø§ÛŒ Ø±ÙˆØ² ${dayNumber}`;
            
            const requiredBalance = dayData.dayNumber * 1000000;
            const statusMessage = dayData.success
                ? `ÙˆØ¶Ø¹ÛŒØª: Ù…ÙˆÙÙ‚ (Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡: ${formatCurrency(requiredBalance)} | Ø®Ø±Ø¬ Ø´Ø¯Ù‡: ${formatCurrency(dayData.spentAmount)})`
                : `ÙˆØ¶Ø¹ÛŒØª: Ø´Ú©Ø³Øª (Ø¨Ø§ÛŒØ¯ ${formatCurrency(requiredBalance)} Ø®Ø±Ø¬ Ù…ÛŒâ€ŒØ´Ø¯)`;
            
            statusElement.textContent = statusMessage;
            statusElement.className = dayData.success ? 'text-green-400 mb-4 text-lg font-semibold' : 'text-red-400 mb-4 text-lg font-semibold';
            
            purchasesContainer.innerHTML = '';
            
            if (dayData.purchases && dayData.purchases.length > 0) {
                dayData.purchases.forEach(purchase => {
                    const purchaseItem = document.createElement('div');
                    purchaseItem.className = 'bg-gray-800 p-3 rounded-lg flex items-center justify-between';
                    
                    let imageHTML = '';
                    if (purchase.image) {
                        imageHTML = `<img src="${purchase.image}" alt="ØªØµÙˆÛŒØ± Ø®Ø±ÛŒØ¯" class="w-16 h-16 object-cover rounded-md ml-3 border border-gray-600 cursor-pointer" onclick="window.open('${purchase.image}', '_blank')">`;
                    } else {
                         imageHTML = `<div class="w-16 h-16 bg-gray-600 rounded-md flex items-center justify-center ml-3 text-xs text-gray-300">Ø¨Ø¯ÙˆÙ† Ø¹Ú©Ø³</div>`;
                    }
                    
                    purchaseItem.innerHTML = `
                        <div class="flex items-center">
                            ${imageHTML}
                            <div>
                                <p class="font-semibold text-gray-200">${purchase.description}</p>
                                <p class="text-sm text-yellow-400">${formatCurrency(purchase.amount)}</p>
                            </div>
                        </div>
                    `;
                    purchasesContainer.appendChild(purchaseItem);
                });
            } else {
                purchasesContainer.innerHTML = '<p class="text-gray-400 text-center">Ø®Ø±ÛŒØ¯ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø±ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
            }

            document.getElementById('details-modal').classList.remove('hidden');
            document.getElementById('details-modal').classList.add('flex');
        };

        // --- Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ ---

        // Ø´Ø±ÙˆØ¹ Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ú©ÙˆØ³
        const startTimer = () => {
            if (timerInterval) clearInterval(timerInterval);

            const timerElement = document.getElementById('countdown-timer');
            const messageElement = document.getElementById('timer-message');

            const updateTimer = () => {
                const elapsed = Date.now() - gameState.startTimestamp;
                const remaining = TWENTY_FOUR_HOURS - elapsed;

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    handleEndOfDay();
                    return;
                }

                const totalSeconds = Math.floor(remaining / 1000);
                const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');

                timerElement.textContent = `${hours}:${minutes}:${seconds}`;

                // Ù¾ÛŒØ§Ù… Ù‡Ø§ÛŒ ØªØ´ÙˆÛŒÙ‚ÛŒ
                if (remaining < 3600000 && remaining > 0) { // Ú©Ù…ØªØ± Ø§Ø² ÛŒÚ© Ø³Ø§Ø¹Øª
                    messageElement.innerHTML = `<span class="text-red-400 font-bold">Ú©Ù…ØªØ± Ø§Ø² Û± Ø³Ø§Ø¹Øª Ù…ÙˆÙ†Ø¯Ù‡! Ø¹Ø¬Ù„Ù‡ Ú©Ù†!</span>`;
                } else if (gameState.currentBalance === 0) {
                     messageElement.innerHTML = `<span class="text-green-400 font-bold">ØªØ¨Ø±ÛŒÚ©! Ú©Ù„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø®Ø±Ø¬ Ø´Ø¯Ù‡! Ù…Ù†ØªØ¸Ø± Ù¾Ø§ÛŒØ§Ù† Ø±ÙˆØ² Ø¨Ø§Ø´.</span>`;
                } else if (gameState.currentBalance <= gameState.initialBalance / 2) {
                     messageElement.innerHTML = `<span class="text-yellow-400 font-bold">Ù†ÛŒÙ…Ù‡â€ŒÛŒ Ø±Ø§Ù‡ Ø±Ùˆ Ø±Ø¯ Ú©Ø±Ø¯ÛŒ! Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡!</span>`;
                } else {
                    messageElement.textContent = 'ØªØ§ Ù¾Ø§ÛŒØ§Ù† Ø±ÙˆØ² ÙØ±ØµØª Ø¯Ø§Ø±ÛŒ Ú©Ù„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø±Ùˆ Ø®Ø±Ø¬ Ú©Ù†ÛŒ.';
                }
            };

            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        };

        // Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø§ÛŒØ§Ù† Ø±ÙˆØ² (Ù…ÙˆÙÙ‚ÛŒØª ÛŒØ§ Ø´Ú©Ø³Øª)
        const handleEndOfDay = () => {
            const success = gameState.currentBalance === 0;
            const requiredBalance = gameState.currentDay * 1000000;

            // Ø°Ø®ÛŒØ±Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±ÙˆØ² ØªÙ…Ø§Ù… Ø´Ø¯Ù‡
            gameState.history.push({
                dayNumber: gameState.currentDay,
                timestamp: gameState.startTimestamp,
                initialBalance: requiredBalance,
                spentAmount: gameState.spentAmount,
                purchases: gameState.purchases,
                success: success
            });

            if (success) {
                // Ù…ÙˆÙÙ‚ÛŒØª: Ø±ÙˆØ² Ø¨Ø¹Ø¯ÛŒ Ùˆ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨ÛŒØ´ØªØ±
                gameState.currentDay += 1;
                gameState.initialBalance = gameState.currentDay * 1000000;
                displayMessage(
                    'ğŸ‰ Ù…ÙˆÙÙ‚ÛŒØª!',
                    `Ø±ÙˆØ² ${gameState.currentDay - 1} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯! Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ±Ø¯Ø§ÛŒ Ø´Ù…Ø§: ${formatCurrency(gameState.initialBalance)}.`,
                    'message-modal',
                    'text-green-400'
                );
            } else {
                // Ø´Ú©Ø³Øª: Ø±ÛŒØ³Øª Ø´Ø¯Ù† Ø¨Ù‡ Ø±ÙˆØ² Ø§ÙˆÙ„
                gameState.currentDay = 1;
                gameState.initialBalance = 1000000;
                displayMessage(
                    'ğŸ˜¢ Ø´Ú©Ø³Øª!',
                    `Ù†ØªÙˆØ§Ù†Ø³ØªÛŒ Ú©Ù„ ${formatCurrency(requiredBalance)} Ø±Ø§ Ø®Ø±Ø¬ Ú©Ù†ÛŒ. Ø¨Ø§Ø²ÛŒ Ø¨Ù‡ Ø±ÙˆØ² Û± Ø¨Ø§ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ${formatCurrency(1000000)} Ø±ÛŒØ³Øª Ø´Ø¯.`,
                    'message-modal',
                    'text-red-400'
                );
            }

            // Ø±ÛŒØ³Øª Ø­Ø§Ù„Øª Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯
            gameState.startTimestamp = Date.now();
            gameState.currentBalance = gameState.initialBalance;
            gameState.spentAmount = 0;
            gameState.purchases = [];

            saveGameState();
            updateUI();
            startTimer();
        };

        // --- Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±Ù… Ø®Ø±ÛŒØ¯ ---

        const handlePurchase = async (event) => {
            event.preventDefault();

            const form = document.getElementById('purchase-form');
            const descriptionInput = document.getElementById('description');
            const amountInput = document.getElementById('amount');
            const imageFileInput = document.getElementById('image-file');
            const formMessage = document.getElementById('form-message');

            const description = descriptionInput.value.trim();
            const amount = parseInt(amountInput.value);

            formMessage.classList.add('hidden');
            formMessage.textContent = '';

            if (amount <= 0 || isNaN(amount)) {
                formMessage.textContent = 'Ù…Ø¨Ù„Øº Ø®Ø±ÛŒØ¯ Ø¨Ø§ÛŒØ¯ Ù…Ø«Ø¨Øª Ø¨Ø§Ø´Ø¯.';
                formMessage.classList.remove('hidden');
                return;
            }
            if (gameState.currentBalance === 0) {
                 formMessage.textContent = 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ù…Ø±ÙˆØ² ØµÙØ± Ø´Ø¯Ù‡ Ø§Ø³Øª! Ø¯ÛŒÚ¯Ø± Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø®Ø±ÛŒØ¯ÛŒ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.';
                 formMessage.classList.remove('hidden');
                 return;
            }
            if (amount > gameState.currentBalance) {
                formMessage.textContent = `Ù…Ø¨Ù„Øº Ø®Ø±ÛŒØ¯ (${formatCurrency(amount)}) Ø§Ø² Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ (${formatCurrency(gameState.currentBalance)}) Ø¨ÛŒØ´ØªØ± Ø§Ø³Øª.`;
                formMessage.classList.remove('hidden');
                return;
            }
            
            let base64Image = null;

            if (imageFileInput.files.length > 0) {
                const file = imageFileInput.files[0];
                const MAX_SIZE_BYTES = 100 * 1024; // 100 KB

                if (file.size > MAX_SIZE_BYTES) {
                    formMessage.textContent = 'Ø­Ø¬Ù… ØªØµÙˆÛŒØ± Ø¨Ø§ÛŒØ¯ Ú©Ù…ØªØ± Ø§Ø² Û±Û°Û° Ú©ÛŒÙ„ÙˆØ¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯.';
                    formMessage.classList.remove('hidden');
                    return;
                }

                try {
                    base64Image = await readFileAsBase64(file);
                } catch (error) {
                    formMessage.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„ ØªØµÙˆÛŒØ±.';
                    formMessage.classList.remove('hidden');
                    return;
                }
            }
            
            // Ú©Ø³Ø± Ù…Ø¨Ù„Øº Ùˆ Ø«Ø¨Øª Ø®Ø±ÛŒØ¯
            gameState.currentBalance -= amount;
            gameState.spentAmount += amount;

            const purchase = {
                description: description,
                amount: amount,
                image: base64Image,
                timestamp: Date.now()
            };

            gameState.purchases.push(purchase);
            
            // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ÙØ±Ù…
            form.reset();
            
            // Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¢Ù¾Ø¯ÛŒØª UI
            saveGameState();
            updateUI();
        };

        const readFileAsBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        // --- ØªØ§Ø¨Ø¹ Ø§ÙˆÙ„ÛŒÙ‡ Ø³Ø§Ø²ÛŒ ---

        const initializeGame = () => {
            loadGameState();

            // Ø§Ú¯Ø± Ø¨Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± Ø§Ø³Øª Ú©Ù‡ Ø§Ø¬Ø±Ø§ Ù…ÛŒ Ø´ÙˆØ¯ ÛŒØ§ Ø´Ø±ÙˆØ¹ Ø±ÙˆØ² Ø¬Ø¯ÛŒØ¯ÛŒ Ù†ÛŒØ³Øª
            if (gameState.startTimestamp === 0) {
                gameState.startTimestamp = Date.now();
                gameState.currentDay = 1;
                gameState.initialBalance = 1000000;
                gameState.currentBalance = gameState.initialBalance;
                gameState.spentAmount = 0;
                gameState.purchases = [];
                saveGameState();
            }

            // Ú†Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø±ÙˆØ² Ù‚Ø¨Ù„ÛŒ Ø¯Ø± Ø­ÛŒÙ† Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨ÙˆØ¯Ù† Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª ÛŒØ§ Ø®ÛŒØ±
            const timePassed = Date.now() - gameState.startTimestamp;
            if (timePassed >= TWENTY_FOUR_HOURS) {
                // Ø§Ú¯Ø± Ø¨ÛŒØ´ØªØ± Ø§Ø² ÛŒÚ© Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø§Ø²ÛŒ Ø±ÛŒØ³Øª Ù…ÛŒ Ø´ÙˆØ¯ (Ø´Ú©Ø³Øª)
                gameState.history.push({
                    dayNumber: gameState.currentDay,
                    timestamp: gameState.startTimestamp,
                    initialBalance: gameState.currentDay * 1000000,
                    spentAmount: gameState.spentAmount,
                    purchases: gameState.purchases,
                    success: false // Ø¯Ø± Ù‡Ø± ØµÙˆØ±Øª Ú©Ù‡ Ø²Ù…Ø§Ù† Ø¨Ú¯Ø°Ø±Ø¯ Ùˆ ØµÙØ± Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø´Ú©Ø³Øª Ù…Ø­Ø³ÙˆØ¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                });

                gameState.currentDay = 1;
                gameState.initialBalance = 1000000;
                gameState.startTimestamp = Date.now();
                gameState.currentBalance = gameState.initialBalance;
                gameState.spentAmount = 0;
                gameState.purchases = [];
                
                displayMessage(
                    'ğŸ˜¢ Ø´Ú©Ø³Øª Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ ØºÛŒØ¨Øª!',
                    `Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† ÙˆØ±ÙˆØ¯ Ø´Ù…Ø§ Ú¯Ø°Ø´ØªÙ‡ Ø§Ø³Øª. Ø¨Ø§Ø²ÛŒ Ø¨Ù‡ Ø±ÙˆØ² Û± Ø±ÛŒØ³Øª Ø´Ø¯.`,
                    'message-modal',
                    'text-red-400'
                );

                saveGameState();
            }

            // Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ
            document.getElementById('purchase-form').addEventListener('submit', handlePurchase);
            updateUI();
            startTimer();
        };

        // Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
        window.onload = initializeGame;

    </script>
</body>
</html>
